---
version: "3"

tasks:
  flux:install:
    desc: Install Flux CRDs
    dir: "{{.KUBERNETES_DIR}}/bootstrap/flux"
    cmds:
      - kubectl apply --server-side --kustomize .

  bootstrap:
    desc: Apply cluster configuration
    dir: "{{.KUBERNETES_DIR}}"
    preconditions:
      - flux check
    cmds:
      - sops --decrypt ./bootstrap/flux/age-key.sops.yaml | kubectl apply -f -
      - sops --decrypt ./bootstrap/flux/github-deploy-key.sops.yaml | kubectl apply -f -
      - sops --decrypt ./flux/vars/cluster-secrets.sops.yaml | kubectl apply -f -
      - kubectl apply -f flux/vars/cluster-settings.yaml

  install:
    desc: Kick off Flux
    dir: "{{.KUBERNETES_DIR}}"
    cmds:
      - kubectl apply --server-side --kustomize ./flux/config
