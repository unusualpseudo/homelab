---
- name: Download Helm 3 binary
  get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: "/tmp/get_helm.sh"
    mode: "700"
  register: _download_binary
  until: _download_binary is succeeded
  retries: 5
  delay: 3
  changed_when: false

- name: Install Helm 3 binary
  command: /tmp/get_helm.sh
  changed_when: false

- name: Download Flux binary
  get_url:
    url: https://fluxcd.io/install.sh
    dest: "/tmp/install.sh"
    mode: "700"
  register: _download_binary
  until: _download_binary is succeeded
  retries: 5
  delay: 3
  changed_when: false

- name: Install Flux binary
  command: /tmp/install.sh
  changed_when: false

- name: Template module to interpolate variables and copy the file
  template:
    src: calico-installation.yaml.j2
    dest: calico-installation.yaml

- name: Install Calico
  command: kubectl create -f {{ item }}
  loop:
    - https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/tigera-operator.yaml
    - calico-installation.yaml

- name: Delete Calico manifest
  become_user: "{{ ansible_user }}"
  file:
    path: calico-installation.yaml
    state: absent

- name: Resource Readiness Check
  run_once: true
  kubernetes.core.k8s_info:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    kind: "{{ item.kind }}"
    name: "{{ item.name }}"
    namespace: "{{ item.namespace | default('') }}"
    wait: true
    wait_sleep: 10
    wait_timeout: 360
  loop:
    - kind: Deployment
      name: tigera-operator
      namespace: tigera-operator
    - kind: Installation
      name: default
